<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ•‘è­·ç¾©æ¶ˆçœ‹æ¿å¹³å°</</title>
  <link rel="icon" href="assets/favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ç”¨æ–¼ç”¢ç”Ÿ Excel çš„ SheetJSï¼ˆåªåœ¨ä½ é»åŒ¯å‡ºæ™‚ç”¨åˆ°ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html{scroll-behavior:smooth}
    .card{border-radius:1rem;box-shadow:0 6px 24px rgba(15,23,42,.08);padding:1.25rem;background:rgba(255,255,255,.96)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.5rem 1rem;border-radius:.75rem;border:1px solid #CBD5E1;transition:.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(15,23,42,.12)}
    .btn-primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .grid-gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .chip{display:inline-block;font-size:.75rem;padding:.125rem .5rem;border-radius:9999px;background:#eef2ff;color:#3730a3}
    .anchor{scroll-margin-top:84px}
    .topnav a{border:1px solid #CBD5E1;border-radius:.75rem;padding:.5rem .9rem;background:#fff}
    .topnav a:hover{background:#f8fafc}
    dialog::backdrop{background:rgba(0,0,0,.35)}
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-40 bg-slate-50/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <img src="assets/logo.png" class="w-8 h-8" alt="logo"/>
      <div class="mr-auto">
        <h1 class="text-xl font-bold">æ•‘è­·ç¾©æ¶ˆçœ‹æ¿å¹³å°</h1>
        <p class="text-xs text-slate-600">æ´»å‹•æ’ç¨‹ãƒ»å‡ºå¸­çµ±è¨ˆãƒ»ç›¸ç°¿ãƒ»æ•™è‚²è¨“ç·´ãƒ»å”å‹¤ç¶“æ­·ãƒ»ç®¡ç†</p>
      </div>
      <nav class="topnav hidden md:flex gap-2">
        <a href="#schedule">è¡Œäº‹æ›†</a>
        <a href="#stats">çµ±è¨ˆ</a>
        <a href="#gallery">ç›¸ç°¿</a>
        <a href="#training">æ•™è‚²è¨“ç·´</a>
        <a href="#experience">å”å‹¤ç¶“æ­·</a>
        <a href="#admin">ç®¡ç†</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 pb-24 space-y-8 mt-4">

    <!-- æ´»å‹•æ’ç¨‹ -->
    <section id="schedule" class="anchor card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">ğŸ“… æ´»å‹•æ’ç¨‹</h2>
        <div class="text-sm text-slate-500">ç”±å¹¹éƒ¨ç·¨è¼¯è©¦ç®—è¡¨ <span class="chip">å…ç™»å…¥ç€è¦½ / å…è¨»å†Šå ±å</span></div>
      </div>
      <div id="calendar-embed" class="w-full aspect-video bg-white rounded-xl overflow-hidden mb-4"></div>
      <div id="event-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      <div id="no-events" class="hidden text-center text-slate-500 py-8">ç›®å‰æ²’æœ‰å³å°‡èˆ‰è¾¦çš„æ´»å‹•</div>
    </section>

    <!-- å‡ºå¸­çµ±è¨ˆï¼ˆæ–°å¢ï¼šåŒ¯å‡º Excel æŒ‰éˆ•ï¼‰ -->
    <section id="stats" class="anchor card">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold mb-4">ğŸ“Š å‡ºå¸­çµ±è¨ˆï¼ˆå«åˆ†éšŠï¼‰</h2>
        <button id="btn-export-xlsx" class="btn" title="ä¸‹è¼‰å…¨é«”å‡ºå¸­å ±è¡¨">åŒ¯å‡º Excel</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card">
          <h3 class="font-semibold mb-2">æœ¬æœˆå‡ºå‹¤ Top 10</h3>
          <ol id="top-attendees" class="list-decimal pl-6 space-y-1 text-sm"></ol>
        </div>
        <div class="card">
          <h3 class="font-semibold mb-2">æ¯å ´æ´»å‹•å‡ºå¸­äººæ•¸</h3>
          <ul id="per-event-counts" class="space-y-1 text-sm"></ul>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-2">åŒ¯å‡ºçš„ Excel æœƒåŒ…å«ã€Œä¾å§“å+åˆ†éšŠçš„å‡ºå‹¤æ¬¡æ•¸ã€ä»¥åŠã€ŒåŸå§‹ç™»è¨˜æ˜ç´°ã€ã€‚</p>
    </section>

    <!-- æ´»å‹•ç›¸ç°¿ -->
    <section id="gallery" class="anchor card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">ğŸ“· æ´»å‹•ç›¸ç°¿ï¼ˆå¤§ç‰ˆé¢ï¼‰</h2>
        <div class="text-xs text-slate-500">ç›¸ç°¿é€£çµè«‹è¨­ã€Œä»»ä½•çŸ¥é“é€£çµè€…å¯æŸ¥çœ‹ã€</div>
      </div>
      <div id="album-list" class="grid-gallery"></div>
    </section>

    <!-- æ•™è‚²è¨“ç·´ -->
    <section id="training" class="anchor card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">ğŸ“ æ•™è‚²è¨“ç·´</h2>
        <button class="btn" id="btn-add-training">ï¼‹ åˆ†äº«ä¸€ç¯‡</button>
      </div>
      <div id="training-list" class="space-y-3"></div>
      <div id="training-empty" class="text-sm text-slate-500">å°šç„¡æ–‡ç« </div>
    </section>

    <!-- å”å‹¤ç¶“æ­· -->
    <section id="experience" class="anchor card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">ğŸ“ å”å‹¤ç¶“æ­·åˆ†äº«</h2>
        <button class="btn" id="btn-add-exp">ï¼‹ æ–°å¢åˆ†äº«</button>
      </div>
      <div id="exp-list" class="space-y-3"></div>
      <div id="exp-empty" class="text-sm text-slate-500">å°šç„¡åˆ†äº«</div>
    </section>

    <!-- ç®¡ç†ï¼ˆå¹¹éƒ¨ï¼‰ -->
    <section id="admin" class="anchor card">
      <h2 class="text-xl font-semibold mb-4">ğŸ›  ç®¡ç†ï¼ˆå¹¹éƒ¨ç”¨ï¼‰</h2>
      <div class="flex items-end gap-2 mb-4">
        <div>
          <label class="block text-xs">ç®¡ç† PINï¼ˆè‹¥æœ‰è¨­å®šï¼‰</label>
          <input id="admin-pin" class="border rounded-lg px-3 py-2" placeholder="è¼¸å…¥ PIN" />
        </div>
        <button class="btn btn-primary" id="btn-load-pending">è¼‰å…¥å¾…è™•ç†</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <h3 class="font-semibold mb-2">å‡ºå¸­å¾…ç¢ºèª</h3>
          <div id="pending-list" class="space-y-2"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">æ–‡ç« å¾…å¯©æ ¸</h3>
          <div id="pending-posts" class="space-y-2"></div>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-3">ä¹Ÿå¯ç›´æ¥åœ¨è©¦ç®—è¡¨ä¿®æ”¹ Attendance/Trainings/Experiences çš„ statusã€‚</p>
    </section>
  </main>

  <!-- å ±å Modal -->
  <div id="join-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
      <h3 class="text-lg font-semibold mb-2">å ±ååƒåŠ </h3>
      <p id="join-event-title" class="text-sm text-slate-600 mb-4"></p>
      <form id="join-form" class="space-y-3">
        <input type="hidden" id="jf-event-id" />
        <div>
          <label class="block text-sm mb-1">å§“å</label>
          <input class="w-full border rounded-xl px-3 py-2" id="jf-name" required />
        </div>
        <div>
          <label class="block text-sm mb-1">åˆ†éšŠ</label>
          <select id="jf-division" class="w-full border rounded-xl px-3 py-2"></select>
        </div>
        <div class="flex items-center gap-2">
          <input type="checkbox" id="jf-confirm" class="h-4 w-4" required />
          <label for="jf-confirm" class="text-sm">æˆ‘ç¢ºå®šæœƒå‡ºå¸­</label>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="jf-cancel" class="btn">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">é€å‡º</button>
        </div>
      </form>
      <p id="jf-result" class="text-sm mt-3"></p>
    </div>
  </div>

  <!-- ï¼ˆé‡é»ï¼‰åˆ†äº«æ–‡ç«  Dialogï¼šä¿®æ­£æŒ‰äº†ã€Œï¼‹åˆ†äº«ã€æ²’æœ‰è·³å‡ºçš„å•é¡Œ -->
  <dialog id="dlg-share" class="rounded-2xl p-0 w-full max-w-xl">
    <form id="share-form" method="dialog" class="p-5 space-y-3">
      <input type="hidden" id="share-kind" value="training"/>
      <h3 class="text-lg font-semibold">åˆ†äº«å…§å®¹</h3>
      <div>
        <label class="block text-sm mb-1">æ¨™é¡Œ</label>
        <input id="share-title" class="w-full border rounded-xl px-3 py-2" required />
      </div>
      <div>
        <label class="block text-sm mb-1">å…§æ–‡</label>
        <textarea id="share-content" class="w-full border rounded-xl px-3 py-2 h-28" required></textarea>
      </div>
      <div>
        <label class="block text-sm mb-1">åœ–ç‰‡ç¶²å€ï¼ˆå¯ç©ºç™½ï¼‰</label>
        <input id="share-image" class="w-full border rounded-xl px-3 py-2" />
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button type="button" id="share-cancel" class="btn">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary">é€å‡º</button>
      </div>
      <p id="share-result" class="text-sm mt-1"></p>
    </form>
  </dialog>

  <footer class="text-center text-xs text-slate-500 py-8">Â© <span id="year"></span> æ•‘è­·ç¾©æ¶ˆçœ‹æ¿å¹³å°</footer>

  <!-- åŒ¯å‡º Excel çš„å°å·¥å…·ï¼šç›´æ¥å‘¼å« API æ‹¿è³‡æ–™ã€ç”¢ .xlsxï¼ˆä¸ä¾è³´ app.js çš„ stateï¼‰ -->
  <script>
    async function fetchConfigForExport(){
      // å’Œ app.js ä¸€æ¨£é¿å…å¿«å–
      const ver = 'v=15';
      const r = await fetch('config.json?'+ver);
      return r.json();
    }
    function toAoa(headers, rows, pick){
      const out = [headers];
      rows.forEach(r=> out.push(pick(r)));
      return out;
    }
    function downloadXlsx(wb, filename){
      XLSX.writeFile(wb, filename);
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      const cancelBtn = document.getElementById('share-cancel');
      if(cancelBtn){
        cancelBtn.addEventListener('click', ()=> document.getElementById('dlg-share').close());
      }
      document.getElementById('btn-export-xlsx')?.addEventListener('click', async ()=>{
        try{
          const cfg = await fetchConfigForExport();
          const api = cfg.apiBase;
          // ç›´æ¥æŠ“å®Œæ•´ bootstrapï¼ˆå« events/attendanceï¼‰
          const res = await fetch(api + '?action=bootstrap');
          const data = await res.json();
          const events = data.events || [];
          const attendance = data.attendance || [];

          // 1) ä¾å§“å+åˆ†éšŠ çµ±è¨ˆæ¬¡æ•¸ï¼ˆæ’é™¤ rejectedï¼‰
          const statMap = new Map();
          attendance.forEach(a=>{
            if(String(a.status||'').toLowerCase()==='rejected') return;
            const key = `${a.name}ï½œ${a.division||'æœªå¡«åˆ†éšŠ'}`;
            statMap.set(key, (statMap.get(key)||0)+1);
          });
          const statRows = Array.from(statMap.entries())
            .sort((a,b)=> b[1]-a[1])
            .map(([k,c])=>{
              const [name, division] = k.split('ï½œ');
              return {name, division, count:c};
            });

          // 2) åŸå§‹æ˜ç´°ï¼ˆä¾æ™‚é–“æ’åºï¼‰
          const raw = attendance.slice().sort((a,b)=> String(a.timestamp||'').localeCompare(String(b.timestamp||'')));

          // 3) å»ºç«‹ Excel
          const wb = XLSX.utils.book_new();

          const statSheet = XLSX.utils.aoa_to_sheet(
