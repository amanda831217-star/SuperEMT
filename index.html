<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SuperEMT | ç¾©æ¶ˆæ•‘è­·éšŠ</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --ring: #0ea5e9; }
    html, body { font-family: 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .card { @apply bg-white rounded-3xl shadow-sm border border-gray-200; }
    .btn { @apply inline-flex items-center gap-2 rounded-2xl px-4 py-2 border border-gray-200 shadow-sm hover:shadow-md active:scale-95 transition; }
    .input { @apply w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2; box-shadow: 0 0 0 0 transparent; }
    .input:focus { box-shadow: 0 0 0 2px var(--ring) inset; }
    .badge { @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-sky-50 text-sky-700 border border-sky-200; }
    .cover-img { @apply w-full h-64 object-cover rounded-2xl; }
    .grid-auto-fill { display: grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap: 1rem; }
    .modal-backdrop { @apply fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">ğŸš‘</span>
        <h1 class="text-xl md:text-2xl font-bold">SuperEMT ç¾©æ¶ˆæ•‘è­·éšŠ</h1>
      </div>
      <nav class="hidden md:flex gap-4 text-sm">
        <a href="#training" class="hover:text-sky-600">æ•™è‚²è¨“ç·´åˆ†äº«</a>
        <a href="#duty" class="hover:text-sky-600">å”å‹¤ç¶“æ­·åˆ†äº«</a>
        <a href="#album" class="hover:text-sky-600">æ´»å‹•ç›¸ç°¿</a>
        <a href="#attendance" class="hover:text-sky-600">æœ¬æœˆå‡ºå‹¤çµ±è¨ˆ</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-6 lg:p-8 space-y-8">
    <!-- æ•™è‚²è¨“ç·´åˆ†äº« -->
    <section id="training" class="card p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold">æ•™è‚²è¨“ç·´åˆ†äº«</h2>
        <button class="btn" onclick="openArticleModal('training')">æ–°å¢åˆ†äº«</button>
      </div>
      <div id="trainingList" class="grid-auto-fill"></div>
      <p id="trainingEmpty" class="text-center text-gray-500 py-6 hidden">ç›®å‰å°šç„¡å…§å®¹ï¼Œé»å³ä¸Šè§’ã€Œæ–°å¢åˆ†äº«ã€ã€‚</p>
    </section>

    <!-- å”å‹¤ç¶“æ­·åˆ†äº« -->
    <section id="duty" class="card p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold">å”å‹¤ç¶“æ­·åˆ†äº«</h2>
        <button class="btn" onclick="openArticleModal('duty')">æ–°å¢åˆ†äº«</button>
      </div>
      <div id="dutyList" class="grid-auto-fill"></div>
      <p id="dutyEmpty" class="text-center text-gray-500 py-6 hidden">ç›®å‰å°šç„¡å…§å®¹ï¼Œé»å³ä¸Šè§’ã€Œæ–°å¢åˆ†äº«ã€ã€‚</p>
    </section>

    <!-- æ´»å‹•ç›¸ç°¿ï¼ˆå°é¢å¤§åœ– + é€£çµé›²ç«¯ç›¸ç°¿ï¼‰ -->
    <section id="album" class="card p-6">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-4">
        <div>
          <h2 class="text-2xl font-semibold">æ´»å‹•ç›¸ç°¿</h2>
          <p class="text-gray-500 text-sm">ä¸‹æ–¹ç›´æ¥é¡¯ç¤ºå°é¢å¤§åœ–ï¼›é»æ“Šå¯æ”¾å¤§é è¦½æˆ–å‰å¾€é›²ç«¯ç›¸ç°¿æŸ¥çœ‹æ›´å¤šã€‚</p>
        </div>
        <div class="flex flex-wrap gap-2">
          <input id="albumLink" class="input md:w-96" type="url" placeholder="é›²ç«¯ç›¸ç°¿é€£çµï¼ˆGoogle Photos / Driveï¼‰" />
          <input id="albumCoverCount" class="input w-28" type="number" min="1" max="12" placeholder="å°é¢æ•¸" />
          <button class="btn" onclick="saveAlbumSettings()">å„²å­˜è¨­å®š</button>
          <button class="btn" onclick="openAlbumModal()">ç®¡ç†å°é¢ç…§ç‰‡</button>
        </div>
      </div>

      <!-- å°é¢å¤§åœ–å€ -->
      <div id="albumCovers" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"></div>
      <p id="albumEmpty" class="text-center text-gray-500 py-6 hidden">å°šæœªè¨­å®šå°é¢ç…§ç‰‡ï¼Œè«‹é»ã€Œç®¡ç†å°é¢ç…§ç‰‡ã€ã€‚</p>

      <div class="mt-4 flex justify-end">
        <a id="albumLinkBtn" class="btn" target="_blank">å‰å¾€é›²ç«¯ç›¸ç°¿ âœ</a>
      </div>
    </section>

    <!-- æœ¬æœˆå‡ºå‹¤çµ±è¨ˆ -->
    <section id="attendance" class="card p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold">æœ¬æœˆå‡ºå‹¤çµ±è¨ˆ</h2>
        <div class="flex gap-2">
          <button class="btn" onclick="downloadExcel()">ä¸‹è¼‰ Excel</button>
          <button class="btn" onclick="clearAttendanceConfirm()">æ¸…ç©ºæœ¬æœˆè³‡æ–™</button>
        </div>
      </div>

      <div class="grid md:grid-cols-4 gap-3 mb-4">
        <input id="attName" class="input" type="text" placeholder="å§“åï¼ˆå¿…å¡«ï¼‰" />
        <input id="attDate" class="input" type="date" />
        <input id="attNote" class="input" type="text" placeholder="å‚™è¨»ï¼ˆå€¼å‹¤åˆ¥/ç­åˆ¥ç­‰ï¼‰" />
        <button class="btn" onclick="addAttendance()">æ–°å¢å‡ºå‹¤ç´€éŒ„</button>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b bg-gray-50">
              <th class="text-left p-2">å§“å</th>
              <th class="text-left p-2">æ—¥æœŸ</th>
              <th class="text-left p-2">å‚™è¨»</th>
              <th class="text-right p-2">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="attTbody"></tbody>
        </table>
      </div>

      <div class="mt-4 grid md:grid-cols-3 gap-4">
        <div class="card p-4">
          <div class="text-sm text-gray-500">æœ¬æœˆç¸½å‡ºå‹¤ç­†æ•¸</div>
          <div id="attTotal" class="text-2xl font-bold">0</div>
        </div>
        <div class="card p-4">
          <div class="text-sm text-gray-500">äººå“¡åå†Šï¼ˆå»é‡ï¼‰</div>
          <div id="attRoster" class="text-2xl font-bold">0</div>
        </div>
        <div class="card p-4">
          <div class="text-sm text-gray-500">æœ€å¸¸å‡ºå‹¤ï¼ˆTop 1ï¼‰</div>
          <div id="attTop" class="text-lg font-semibold">â€”</div>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Modals ===== -->
  <!-- æ–°å¢/ç·¨è¼¯ æ–‡ç«  -->
  <div id="articleModal" class="hidden modal-backdrop">
    <div class="card w-full max-w-2xl p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 id="articleModalTitle" class="text-xl font-semibold">æ–°å¢åˆ†äº«</h3>
        <button class="btn" onclick="closeArticleModal()">é—œé–‰</button>
      </div>
      <div class="grid gap-3">
        <input id="articleTitle" class="input" placeholder="æ¨™é¡Œï¼ˆå¿…å¡«ï¼‰" />
        <textarea id="articleContent" class="input" rows="6" placeholder="å…§æ–‡ï¼ˆå¯è²¼ä¸Šç°¡çŸ­å¿ƒå¾—æˆ–é€£çµï¼‰"></textarea>
        <div class="grid md:grid-cols-2 gap-3">
          <input id="articleDate" class="input" type="date" />
          <input id="articlePhotos" class="input" placeholder="ç…§ç‰‡ URLï¼ˆå¤šå¼µä»¥é€—è™Ÿåˆ†éš”ï¼Œå¯ç©ºï¼‰" />
        </div>
        <div class="flex justify-end gap-2">
          <button class="btn" onclick="saveArticle()">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç®¡ç†ç›¸ç°¿å°é¢ -->
  <div id="albumModal" class="hidden modal-backdrop">
    <div class="card w-full max-w-3xl p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-xl font-semibold">ç®¡ç†å°é¢ç…§ç‰‡</h3>
        <button class="btn" onclick="closeAlbumModal()">é—œé–‰</button>
      </div>
      <div class="grid md:grid-cols-3 gap-3 mb-3">
        <input id="albumImgUrl" class="input" placeholder="è²¼ä¸Šåœ–ç‰‡ç¶²å€ï¼ˆjpg/pngï¼‰" />
        <input id="albumImgTitle" class="input" placeholder="ç…§ç‰‡èªªæ˜ï¼ˆé¸å¡«ï¼‰" />
        <button class="btn" onclick="addAlbumImage()">æ–°å¢å°é¢</button>
      </div>

      <div id="albumManageList" class="grid-auto-fill"></div>
      <p id="albumManageEmpty" class="text-center text-gray-500 py-6 hidden">å°šç„¡å°é¢ï¼Œè«‹å…ˆæ–°å¢ã€‚</p>
    </div>
  </div>

  <!-- åœ–ç‰‡æ”¾å¤§é è¦½ -->
  <div id="lightbox" class="hidden modal-backdrop" onclick="closeLightbox()">
    <img id="lightboxImg" alt="preview" class="max-h-[90vh] rounded-2xl shadow-2xl" />
  </div>

  <footer class="text-center text-xs text-gray-500 py-8">
    Â© <span id="year"></span> SuperEMT. All rights reserved.
  </footer>

  <script>
    // ===== LocalStorage Keys =====
    const LS = {
      TRAINING: 'ak_training_articles',
      DUTY: 'ak_duty_articles',
      ALBUM: 'ak_album_images', // [{url, title, id}]
      ALBUM_LINK: 'ak_album_link',
      ALBUM_COVER_COUNT: 'ak_album_cover_count',
      ATT: 'ak_attendance', // [{id, name, date, note}]
    };

    const $ = (id) => document.getElementById(id);

    const todayStr = () => new Date().toISOString().slice(0,10);
    const uid = () => Math.random().toString(36).slice(2);

    const loadJSON = (k, fb) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : fb; } catch { return fb; } };
    const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    // ===== æ–‡ç« ï¼ˆæ•™è‚²è¨“ç·´ / å”å‹¤ï¼‰ =====
    let currentArticleType = 'training'; // 'training' | 'duty'
    let editingArticleId = null;

    function renderArticleList(type) {
      const listEl = type === 'training' ? $('trainingList') : $('dutyList');
      const emptyEl = type === 'training' ? $('trainingEmpty') : $('dutyEmpty');
      const data = loadJSON(type === 'training' ? LS.TRAINING : LS.DUTY, []);

      listEl.innerHTML = '';
      if (!data.length) {
        emptyEl.classList.remove('hidden');
        return;
      }
      emptyEl.classList.add('hidden');

      data.sort((a,b) => (b.date || '').localeCompare(a.date || ''));

      data.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card p-4 flex flex-col gap-3';

        const header = document.createElement('div');
        header.className = 'flex items-start justify-between gap-3';
        const title = document.createElement('div');
        title.innerHTML = `<div class="text-lg font-semibold">${escapeHtml(item.title)}</div>
                           <div class="text-xs text-gray-500 mt-0.5">${item.date || ''}</div>`;
        const actions = document.createElement('div');
        actions.className = 'flex gap-2';
        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn';
        btnEdit.textContent = 'ç·¨è¼¯';
        btnEdit.onclick = () => openArticleModal(type, item.id);
        const btnDel = document.createElement('button');
        btnDel.className = 'btn';
        btnDel.textContent = 'åˆªé™¤';
        btnDel.onclick = () => deleteArticle(type, item.id);
        actions.append(btnEdit, btnDel);
        header.append(title, actions);

        const content = document.createElement('div');
        content.className = 'text-sm leading-7 whitespace-pre-wrap';
        content.textContent = item.content || '';

        card.append(header, content);

        if (item.photos && item.photos.length) {
          const grid = document.createElement('div');
          grid.className = 'grid grid-cols-2 md:grid-cols-3 gap-3';
          item.photos.forEach(src => {
            const img = document.createElement('img');
            img.src = src; img.alt = 'photo';
            img.className = 'w-full h-40 object-cover rounded-xl cursor-zoom-in';
            img.onclick = () => openLightbox(src);
            grid.append(img);
          });
          card.append(grid);
        }

        listEl.append(card);
      });
    }

    function openArticleModal(type, id=null) {
      currentArticleType = type;
      editingArticleId = id;
      $('articleModal').classList.remove('hidden');
      $('articleModalTitle').textContent = id ? 'ç·¨è¼¯åˆ†äº«' : 'æ–°å¢åˆ†äº«';
      // å¡«å…¥è³‡æ–™ï¼ˆæˆ–é è¨­ï¼‰
      if (id) {
        const data = loadJSON(type === 'training' ? LS.TRAINING : LS.DUTY, []);
        const it = data.find(x => x.id === id);
        $('articleTitle').value = it?.title || '';
        $('articleContent').value = it?.content || '';
        $('articleDate').value = it?.date || todayStr();
        $('articlePhotos').value = (it?.photos || []).join(',');
      } else {
        $('articleTitle').value = '';
        $('articleContent').value = '';
        $('articleDate').value = todayStr();
        $('articlePhotos').value = '';
      }
    }

    function closeArticleModal() { $('articleModal').classList.add('hidden'); }

    function saveArticle() {
      const title = $('articleTitle').value.trim();
      const content = $('articleContent').value.trim();
      const date = $('articleDate').value;
      const photos = $('articlePhotos').value.trim()
        ? $('articlePhotos').value.split(',').map(s => s.trim()).filter(Boolean)
        : [];
      if (!title) { alert('è«‹è¼¸å…¥æ¨™é¡Œ'); return; }

      const key = currentArticleType === 'training' ? LS.TRAINING : LS.DUTY;
      const list = loadJSON(key, []);

      if (editingArticleId) {
        const idx = list.findIndex(x => x.id === editingArticleId);
        if (idx >= 0) list[idx] = { ...list[idx], title, content, date, photos };
      } else {
        list.push({ id: uid(), title, content, date, photos });
      }
      saveJSON(key, list);
      closeArticleModal();
      renderArticleList(currentArticleType);
    }

    function deleteArticle(type, id) {
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤åˆ†äº«ï¼Ÿ')) return;
      const key = type === 'training' ? LS.TRAINING : LS.DUTY;
      const list = loadJSON(key, []);
      const newList = list.filter(x => x.id !== id);
      saveJSON(key, newList);
      renderArticleList(type);
    }

    // ===== ç›¸ç°¿ =====
    function renderAlbum() {
      const coverCount = Number(loadJSON(LS.ALBUM_COVER_COUNT, 6)) || 6;
      $('albumCoverCount').value = coverCount;
      const albumLink = loadJSON(LS.ALBUM_LINK, '');
      $('albumLink').value = albumLink;
      const arr = loadJSON(LS.ALBUM, []);

      const wrap = $('albumCovers');
      wrap.innerHTML = '';

      if (!arr.length) {
        $('albumEmpty').classList.remove('hidden');
      } else {
        $('albumEmpty').classList.add('hidden');
        arr.slice(0, coverCount).forEach(it => {
          const card = document.createElement('div');
          card.className = 'card p-2';
          const img = document.createElement('img');
          img.src = it.url; img.alt = it.title || 'album';
          img.className = 'cover-img cursor-zoom-in';
          img.onclick = () => openLightbox(it.url);
          const cap = document.createElement('div');
          cap.className = 'text-sm text-gray-600 p-2';
          cap.textContent = it.title || '';
          card.append(img, cap);
          wrap.append(card);
        });
      }

      const linkBtn = $('albumLinkBtn');
      linkBtn.href = albumLink || '#';
      linkBtn.classList.toggle('pointer-events-none', !albumLink);
      linkBtn.classList.toggle('opacity-50', !albumLink);
    }

    function openAlbumModal() {
      $('albumModal').classList.remove('hidden');
      renderAlbumManage();
    }
    function closeAlbumModal() { $('albumModal').classList.add('hidden'); }

    function renderAlbumManage() {
      const listEl = $('albumManageList');
      const emptyEl = $('albumManageEmpty');
      const arr = loadJSON(LS.ALBUM, []);
      listEl.innerHTML = '';
      if (!arr.length) { emptyEl.classList.remove('hidden'); return; }
      emptyEl.classList.add('hidden');

      arr.forEach(it => {
        const item = document.createElement('div');
        item.className = 'card p-3 flex gap-3';
        item.innerHTML = `
          <img src="${it.url}" alt="" class="w-28 h-20 object-cover rounded-xl" />
          <div class="flex-1">
            <div class="font-medium">${escapeHtml(it.title || '')}</div>
            <div class="text-xs text-gray-500 break-all">${escapeHtml(it.url)}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn" onclick="removeAlbumImage('${it.id}')">åˆªé™¤</button>
          </div>
        `;
        listEl.append(item);
      });
    }

    function addAlbumImage() {
      const url = $('albumImgUrl').value.trim();
      const title = $('albumImgTitle').value.trim();
      if (!url) { alert('è«‹è²¼ä¸Šåœ–ç‰‡ç¶²å€'); return; }
      const arr = loadJSON(LS.ALBUM, []);
      arr.unshift({ id: uid(), url, title });
      saveJSON(LS.ALBUM, arr);
      $('albumImgUrl').value = '';
      $('albumImgTitle').value = '';
      renderAlbumManage();
      renderAlbum();
    }

    function removeAlbumImage(id) {
      const arr = loadJSON(LS.ALBUM, []);
      saveJSON(LS.ALBUM, arr.filter(x => x.id !== id));
      renderAlbumManage();
      renderAlbum();
    }

    function saveAlbumSettings() {
      const link = $('albumLink').value.trim();
      const count = Math.max(1, Math.min(12, Number($('albumCoverCount').value || 6)));
      saveJSON(LS.ALBUM_LINK, link);
      saveJSON(LS.ALBUM_COVER_COUNT, count);
      renderAlbum();
      alert('ç›¸ç°¿è¨­å®šå·²å„²å­˜');
    }

    // ===== åœ–ç‰‡é è¦½ =====
    function openLightbox(src) {
      $('lightboxImg').src = src; $('lightbox').classList.remove('hidden');
    }
    function closeLightbox() { $('lightbox').classList.add('hidden'); }

    // ===== å‡ºå‹¤ =====
    function renderAttendance() {
      const tbody = $('attTbody');
      const list = loadJSON(LS.ATT, []);
      tbody.innerHTML = '';

      list.sort((a,b) => (a.date || '').localeCompare(b.date || ''));

      list.forEach(it => {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="p-2">${escapeHtml(it.name)}</td>
          <td class="p-2">${it.date || ''}</td>
          <td class="p-2">${escapeHtml(it.note || '')}</td>
          <td class="p-2 text-right">
            <button class="btn" onclick="deleteAttendance('${it.id}')">åˆªé™¤</button>
          </td>
        `;
        tbody.append(tr);
      });

      // ç¸½æ•¸
      $('attTotal').textContent = String(list.length);
      // åå†Š
      const names = Array.from(new Set(list.map(x => x.name).filter(Boolean)));
      $('attRoster').textContent = String(names.length);
      // Top å‡ºå‹¤
      const counts = {};
      list.forEach(x => { counts[x.name] = (counts[x.name]||0) + 1; });
      let topName = 'â€”', topCount = 0;
      Object.entries(counts).forEach(([n,c]) => { if (c > topCount) { topCount = c; topName = n; } });
      $('attTop').textContent = topName === 'â€”' ? 'â€”' : `${topName}ï¼ˆ${topCount}æ¬¡ï¼‰`;
    }

    function addAttendance() {
      const name = $('attName').value.trim();
      const date = $('attDate').value || todayStr();
      const note = $('attNote').value.trim();
      if (!name) { alert('è«‹è¼¸å…¥å§“å'); return; }
      const list = loadJSON(LS.ATT, []);
      list.push({ id: uid(), name, date, note });
      saveJSON(LS.ATT, list);
      $('attName').value = '';
      $('attNote').value = '';
      renderAttendance();
    }

    function deleteAttendance(id) {
      const list = loadJSON(LS.ATT, []);
      saveJSON(LS.ATT, list.filter(x => x.id !== id));
      renderAttendance();
    }

    function clearAttendanceConfirm() {
      if (!confirm('ç¢ºå®šæ¸…ç©ºæœ¬æœˆå‡ºå‹¤è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
      saveJSON(LS.ATT, []);
      renderAttendance();
    }

    // ç”¢å‡º Excelï¼šAttendanceï¼ˆæ˜ç´°ï¼‰ã€Statsï¼ˆå½™ç¸½ï¼‰
    function downloadExcel() {
      const list = loadJSON(LS.ATT, []);
      // æ˜ç´°
      const detail = list.map(x => ({ å§“å: x.name, æ—¥æœŸ: x.date, å‚™è¨»: x.note || '' }));
      // å½™ç¸½ï¼ˆäººå“¡æ¬¡æ•¸ã€æ—¥æœŸåˆ†ä½ˆï¼‰
      const perName = {};
      const perDate = {};
      list.forEach(x => {
        perName[x.name] = (perName[x.name]||0) + 1;
        perDate[x.date] = (perDate[x.date]||0) + 1;
      });
      const statName = Object.entries(perName).map(([k,v]) => ({ å§“å: k, æ¬¡æ•¸: v }));
      const statDate = Object.entries(perDate).map(([k,v]) => ({ æ—¥æœŸ: k, æ¬¡æ•¸: v }));

      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.json_to_sheet(detail);
      XLSX.utils.book_append_sheet(wb, ws1, 'Attendance');
      const ws2 = XLSX.utils.json_to_sheet(statName);
      XLSX.utils.book_append_sheet(wb, ws2, 'Stats_ByName');
      const ws3 = XLSX.utils.json_to_sheet(statDate);
      XLSX.utils.book_append_sheet(wb, ws3, 'Stats_ByDate');

      const ym = new Date();
      const fname = `å‡ºå‹¤çµ±è¨ˆ_${ym.getFullYear()}-${String(ym.getMonth()+1).padStart(2,'0')}.xlsx`;
      XLSX.writeFile(wb, fname);
    }

    // ===== Utils =====
    function escapeHtml(str='') {
      return str.replace(/[&<>'"]/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c]));
    }

    // ===== åˆå§‹ =====
    function initSeed() {
      // åƒ…åœ¨é¦–æ¬¡ç„¡è³‡æ–™æ™‚å¯«å…¥ç¤ºä¾‹ï¼ˆé¿å…ç©ºç™½é ï¼‰
      if (!localStorage.getItem(LS.ALBUM)) {
        saveJSON(LS.ALBUM, [
          { id: uid(), url: 'https://images.unsplash.com/photo-1558980664-10b3155f0f38?q=80&w=1600&auto=format&fit=crop', title: 'CPR è¨“ç·´' },
          { id: uid(), url: 'https://images.unsplash.com/photo-1530025896945-8f08f5328b9f?q=80&w=1600&auto=format&fit=crop', title: 'æ•‘è­·è»Šæ•´å‚™' },
          { id: uid(), url: 'https://images.unsplash.com/photo-1556911220-e15b29be8c8f?q=80&w=1600&auto=format&fit=crop', title: 'å™¨ææª¢é»' },
          { id: uid(), url: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1600&auto=format&fit=crop', title: 'å ´ç«™æ•™è‚²è¨“ç·´' },
          { id: uid(), url: 'https://images.unsplash.com/photo-1530213786676-41ad9f7736f6?q=80&w=1600&auto=format&fit=crop', title: 'ç¤¾å€å®£å°' },
          { id: uid(), url: 'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?q=80&w=1600&auto=format&fit=crop', title: 'æ€¥æ•‘æ¼”ç·´' },
        ]);
      }
      if (!localStorage.getItem(LS.ALBUM_COVER_COUNT)) saveJSON(LS.ALBUM_COVER_COUNT, 6);
      if (!localStorage.getItem(LS.ALBUM_LINK)) saveJSON(LS.ALBUM_LINK, '');
    }

    function init() {
      $('year').textContent = new Date().getFullYear();
      initSeed();
      renderArticleList('training');
      renderArticleList('duty');
      renderAlbum();
      renderAttendance();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
