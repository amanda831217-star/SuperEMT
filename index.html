<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>救護義消看板平台</</title>
  <link rel="icon" href="assets/favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 用於產生 Excel 的 SheetJS（只在你點匯出時用到） -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html{scroll-behavior:smooth}
    .card{border-radius:1rem;box-shadow:0 6px 24px rgba(15,23,42,.08);padding:1.25rem;background:rgba(255,255,255,.96)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.5rem 1rem;border-radius:.75rem;border:1px solid #CBD5E1;transition:.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(15,23,42,.12)}
    .btn-primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .grid-gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .chip{display:inline-block;font-size:.75rem;padding:.125rem .5rem;border-radius:9999px;background:#eef2ff;color:#3730a3}
    .anchor{scroll-margin-top:84px}
    .topnav a{border:1px solid #CBD5E1;border-radius:.75rem;padding:.5rem .9rem;background:#fff}
    .topnav a:hover{background:#f8fafc}
    dialog::backdrop{background:rgba(0,0,0,.35)}
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-40 bg-slate-50/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <img src="assets/logo.png" class="w-8 h-8" alt="logo"/>
      <div class="mr-auto">
        <h1 class="text-xl font-bold">救護義消看板平台</h1>
        <p class="text-xs text-slate-600">活動排程・出席統計・相簿・教育訓練・協勤經歷・管理</p>
      </div>
      <nav class="topnav hidden md:flex gap-2">
        <a href="#schedule">行事曆</a>
        <a href="#stats">統計</a>
        <a href="#gallery">相簿</a>
        <a href="#training">教育訓練</a>
        <a href="#experience">協勤經歷</a>
        <a href="#admin">管理</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 pb-24 space-y-8 mt-4">

    <!-- 活動排程 -->
    <section id="schedule" class="anchor card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">📅 活動排程</h2>
        <div class="text-sm text-slate-500">由幹部編輯試算表 <span class="chip">免登入瀏覽 / 免註冊報名</span></div>
      </div>
      <div id="calendar-embed" class="w-full aspect-video bg-white rounded-xl overflow-hidden mb-4"></div>
      <div id="event-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      <div id="no-events" class="hidden text-center text-slate-500 py-8">目前沒有即將舉辦的活動</div>
    </section>

    <!-- 出席統計（新增：匯出 Excel 按鈕） -->
    <section id="stats" class="anchor card">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold mb-4">📊 出席統計（含分隊）</h2>
        <button id="btn-export-xlsx" class="btn" title="下載全體出席報表">匯出 Excel</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card">
          <h3 class="font-semibold mb-2">本月出勤 Top 10</h3>
          <ol id="top-attendees" class="list-decimal pl-6 space-y-1 text-sm"></ol>
        </div>
        <div class="card">
          <h3 class="font-semibold mb-2">每場活動出席人數</h3>
          <ul id="per-event-counts" class="space-y-1 text-sm"></ul>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-2">匯出的 Excel 會包含「依姓名+分隊的出勤次數」以及「原始登記明細」。</p>
    </section>

    <!-- 活動相簿 -->
    <section id="gallery" class="anchor card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">📷 活動相簿（大版面）</h2>
        <div class="text-xs text-slate-500">相簿連結請設「任何知道連結者可查看」</div>
      </div>
      <div id="album-list" class="grid-gallery"></div>
    </section>

    <!-- 教育訓練 -->
    <section id="training" class="anchor card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">🎓 教育訓練</h2>
        <button class="btn" id="btn-add-training">＋ 分享一篇</button>
      </div>
      <div id="training-list" class="space-y-3"></div>
      <div id="training-empty" class="text-sm text-slate-500">尚無文章</div>
    </section>

    <!-- 協勤經歷 -->
    <section id="experience" class="anchor card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">📝 協勤經歷分享</h2>
        <button class="btn" id="btn-add-exp">＋ 新增分享</button>
      </div>
      <div id="exp-list" class="space-y-3"></div>
      <div id="exp-empty" class="text-sm text-slate-500">尚無分享</div>
    </section>

    <!-- 管理（幹部） -->
    <section id="admin" class="anchor card">
      <h2 class="text-xl font-semibold mb-4">🛠 管理（幹部用）</h2>
      <div class="flex items-end gap-2 mb-4">
        <div>
          <label class="block text-xs">管理 PIN（若有設定）</label>
          <input id="admin-pin" class="border rounded-lg px-3 py-2" placeholder="輸入 PIN" />
        </div>
        <button class="btn btn-primary" id="btn-load-pending">載入待處理</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <h3 class="font-semibold mb-2">出席待確認</h3>
          <div id="pending-list" class="space-y-2"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">文章待審核</h3>
          <div id="pending-posts" class="space-y-2"></div>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-3">也可直接在試算表修改 Attendance/Trainings/Experiences 的 status。</p>
    </section>
  </main>

  <!-- 報名 Modal -->
  <div id="join-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
      <h3 class="text-lg font-semibold mb-2">報名參加</h3>
      <p id="join-event-title" class="text-sm text-slate-600 mb-4"></p>
      <form id="join-form" class="space-y-3">
        <input type="hidden" id="jf-event-id" />
        <div>
          <label class="block text-sm mb-1">姓名</label>
          <input class="w-full border rounded-xl px-3 py-2" id="jf-name" required />
        </div>
        <div>
          <label class="block text-sm mb-1">分隊</label>
          <select id="jf-division" class="w-full border rounded-xl px-3 py-2"></select>
        </div>
        <div class="flex items-center gap-2">
          <input type="checkbox" id="jf-confirm" class="h-4 w-4" required />
          <label for="jf-confirm" class="text-sm">我確定會出席</label>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="jf-cancel" class="btn">取消</button>
          <button type="submit" class="btn btn-primary">送出</button>
        </div>
      </form>
      <p id="jf-result" class="text-sm mt-3"></p>
    </div>
  </div>

  <!-- （重點）分享文章 Dialog：修正按了「＋分享」沒有跳出的問題 -->
  <dialog id="dlg-share" class="rounded-2xl p-0 w-full max-w-xl">
    <form id="share-form" method="dialog" class="p-5 space-y-3">
      <input type="hidden" id="share-kind" value="training"/>
      <h3 class="text-lg font-semibold">分享內容</h3>
      <div>
        <label class="block text-sm mb-1">標題</label>
        <input id="share-title" class="w-full border rounded-xl px-3 py-2" required />
      </div>
      <div>
        <label class="block text-sm mb-1">內文</label>
        <textarea id="share-content" class="w-full border rounded-xl px-3 py-2 h-28" required></textarea>
      </div>
      <div>
        <label class="block text-sm mb-1">圖片網址（可空白）</label>
        <input id="share-image" class="w-full border rounded-xl px-3 py-2" />
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button type="button" id="share-cancel" class="btn">取消</button>
        <button type="submit" class="btn btn-primary">送出</button>
      </div>
      <p id="share-result" class="text-sm mt-1"></p>
    </form>
  </dialog>

  <footer class="text-center text-xs text-slate-500 py-8">© <span id="year"></span> 救護義消看板平台</footer>

  <!-- 匯出 Excel 的小工具：直接呼叫 API 拿資料、產 .xlsx（不依賴 app.js 的 state） -->
  <script>
    async function fetchConfigForExport(){
      // 和 app.js 一樣避免快取
      const ver = 'v=15';
      const r = await fetch('config.json?'+ver);
      return r.json();
    }
    function toAoa(headers, rows, pick){
      const out = [headers];
      rows.forEach(r=> out.push(pick(r)));
      return out;
    }
    function downloadXlsx(wb, filename){
      XLSX.writeFile(wb, filename);
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      const cancelBtn = document.getElementById('share-cancel');
      if(cancelBtn){
        cancelBtn.addEventListener('click', ()=> document.getElementById('dlg-share').close());
      }
      document.getElementById('btn-export-xlsx')?.addEventListener('click', async ()=>{
        try{
          const cfg = await fetchConfigForExport();
          const api = cfg.apiBase;
          // 直接抓完整 bootstrap（含 events/attendance）
          const res = await fetch(api + '?action=bootstrap');
          const data = await res.json();
          const events = data.events || [];
          const attendance = data.attendance || [];

          // 1) 依姓名+分隊 統計次數（排除 rejected）
          const statMap = new Map();
          attendance.forEach(a=>{
            if(String(a.status||'').toLowerCase()==='rejected') return;
            const key = `${a.name}｜${a.division||'未填分隊'}`;
            statMap.set(key, (statMap.get(key)||0)+1);
          });
          const statRows = Array.from(statMap.entries())
            .sort((a,b)=> b[1]-a[1])
            .map(([k,c])=>{
              const [name, division] = k.split('｜');
              return {name, division, count:c};
            });

          // 2) 原始明細（依時間排序）
          const raw = attendance.slice().sort((a,b)=> String(a.timestamp||'').localeCompare(String(b.timestamp||'')));

          // 3) 建立 Excel
          const wb = XLSX.utils.book_new();

          const statSheet = XLSX.utils.aoa_to_sheet(
